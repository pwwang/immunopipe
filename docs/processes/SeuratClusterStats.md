# SeuratClusterStats

Statistics of the clustering.

Including the number/fraction of cells in each cluster, the gene expression values
and dimension reduction plots. It's also possible to perform stats on
TCR clones/clusters or other metadata for each T-cell cluster.<br />

## Input

- `srtobj`:
    The seurat object loaded by `SeuratClustering`

## Output

- `outdir`: *Default: `{{in.srtobj | stem}}.cluster_stats`*. <br />
    The output directory.<br />
    Different types of plots will be saved in different subdirectories.<br />
    For example, `clustree` plots will be saved in `clustrees` subdirectory.<br />
    For each case in `envs.clustrees`, both the png and pdf files will be saved.<br />

## Environment Variables

- `mutaters` *(`type=json`)*: *Default: `{}`*. <br />
    The mutaters to mutate the metadata to subset the cells.<br />
    The mutaters will be applied in the order specified.<br />
    You can also use the clone selectors to select the TCR clones/clusters.<br />
    See <https://user.github.io/scplotter/reference/clone_selectors.html>.<br />
- `cache` *(`type=auto`)*: *Default: `/tmp`*. <br />
    Whether to cache the plots.<br />
    Currently only plots for features are supported, since creating the those
    plots can be time consuming.<br />
    If `True`, the plots will be cached in the job output directory, which will
    be not cleaned up when job is rerunning.<br />
- `clustrees_defaults` *(`ns`)*:
    The parameters for the clustree plots.<br />
    - `devpars` *(`ns`)*:
        The device parameters for the clustree plot.<br />
        - `res` *(`type=int`)*: *Default: `100`*. <br />
            The resolution of the plots.<br />
        - `height` *(`type=int`)*:
            The height of the plots.<br />
        - `width` *(`type=int`)*:
            The width of the plots.<br />
    - `more_formats` *(`type=list`)*: *Default: `[]`*. <br />
        The formats to save the plots other than `png`.<br />
    - `save_code` *(`flag`)*: *Default: `False`*. <br />
        Whether to save the code to reproduce the plot.<br />
    - `prefix` *(`type=auto`)*: *Default: `True`*. <br />
        string indicating columns containing clustering information.<br />
        The trailing dot is not necessary and will be added automatically.<br />
        When `TRUE`, clustrees will be plotted when there is `FindClusters` or
        `FindClusters.*` in the `obj@commands`.<br />
        The latter is generated by `SeuratSubClustering`.<br />
        This will be ignored when `envs.clustrees` is specified
        (the prefix of each case must be specified separately).<br />
    - `<more>`:
        Other arguments passed to `scplotter::ClustreePlot`.<br />
        See <https://user.github.io/scplotter/reference/ClustreePlot.html>
- `clustrees` *(`type=json`)*: *Default: `{}`*. <br />
    The cases for clustree plots.<br />
    Keys are the names of the plots and values are the dicts inherited from `env.clustrees_defaults` except `prefix`.<br />
    There is no default case for `clustrees`.<br />
- `stats_defaults` *(`ns`)*:
    The default parameters for `stats`.<br />
    This is to do some basic statistics on the clusters/cells. For more comprehensive analysis,
    see <https://user.github.io/scplotter/reference/CellStatPlot.html>.<br />
    The parameters from the cases can overwrite the default parameters.<br />
    - `subset`:
        An expression to subset the cells, will be passed to `tidyrseurat::filter()`.<br />
    - `devpars` *(`ns`)*:
        The device parameters for the clustree plot.<br />
        - `res` *(`type=int`)*: *Default: `100`*. <br />
            The resolution of the plots.<br />
        - `height` *(`type=int`)*:
            The height of the plots.<br />
        - `width` *(`type=int`)*:
            The width of the plots.<br />
    - `descr`:
        The description of the plot, showing in the report.<br />
    - `more_formats` *(`type=list`)*: *Default: `[]`*. <br />
        The formats to save the plots other than `png`.<br />
    - `save_code` *(`flag`)*: *Default: `False`*. <br />
        Whether to save the code to reproduce the plot.<br />
    - `save_data` *(`flag`)*: *Default: `False`*. <br />
        Whether to save the data used to generate the plot.<br />
    - `<more>`:
        Other arguments passed to `scplotter::CellStatPlot`.<br />
        See <https://user.github.io/scplotter/reference/CellStatPlot.html>.<br />
- `stats` *(`type=json`)*: *Default: `{'Number of cells in each cluster (Bar Chart)': Diot({'plot_type': 'bar', 'x_text_angle': 90}), 'Number of cells in each cluster by Sample (Bar Chart)': Diot({'plot_type': 'bar', 'group_by': 'Sample', 'x_text_angle': 90})}`*. <br />
    The number/fraction of cells to plot.<br />
    Keys are the names of the plots and values are the dicts inherited from `env.stats_defaults`.<br />
    Here are some examples -

    ```python
    {
        "nCells_All": {},
        "nCells_Sample": {"group_by": "Sample"},
        "fracCells_Sample": {"scale_y": True, "group_by": "Sample", plot_type = "pie"},
    }
    ```

- `ngenes_defaults` *(`ns`)*:
    The default parameters for `ngenes`.<br />
    The default parameters to plot the number of genes expressed in each cell.<br />
    - `more_formats` *(`type=list`)*: *Default: `[]`*. <br />
        The formats to save the plots other than `png`.<br />
    - `subset`:
        An expression to subset the cells, will be passed to `tidyrseurat::filter()`.<br />
    - `devpars` *(`ns`)*:
        The device parameters for the plots.<br />
        - `res` *(`type=int`)*: *Default: `100`*. <br />
            The resolution of the plots.<br />
        - `height` *(`type=int`)*: *Default: `800`*. <br />
            The height of the plots.<br />
        - `width` *(`type=int`)*: *Default: `1000`*. <br />
            The width of the plots.<br />
- `ngenes` *(`type=json`)*: *Default: `{'Number of genes expressed in each cluster': Diot({})}`*. <br />
    The number of genes expressed in each cell.<br />
    Keys are the names of the plots and values are the dicts inherited from `env.ngenes_defaults`.<br />
- `features_defaults` *(`ns`)*:
    The default parameters for `features`.<br />
    - `features` *(`type=auto`)*:
        The features to plot.<br />
        It can be either a string with comma separated features, a list of features, a file path with `file://` prefix with features
        (one per line), or an integer to use the top N features from `VariantFeatures(srtobj)`.<br />
        It can also be a dict with the keys as the feature group names and the values as the features, which
        is used for heatmap to group the features.<br />
    - `order_by` *(`type=auto`)*:
        The order of the clusters to show on the plot.<br />
        An expression passed to `dplyr::arrange()` on the grouped meta data frame (by `ident`).<br />
        For example, you can order the clusters by the activation score of
        the cluster: `desc(mean(ActivationScore, na.rm = TRUE))`, suppose you have a column
        `ActivationScore` in the metadata.<br />
        You may also specify the literal order of the clusters by a list of strings (at least two).<br />
    - `subset`:
        An expression to subset the cells, will be passed to `tidyrseurat::filter()`.<br />
    - `devpars` *(`ns`)*:
        The device parameters for the plots.<br />
        - `res` *(`type=int`)*: *Default: `100`*. <br />
            The resolution of the plots.<br />
        - `height` *(`type=int`)*:
            The height of the plots.<br />
        - `width` *(`type=int`)*:
            The width of the plots.<br />
    - `descr`:
        The description of the plot, showing in the report.<br />
    - `more_formats` *(`type=list`)*: *Default: `[]`*. <br />
        The formats to save the plots other than `png`.<br />
    - `save_code` *(`flag`)*: *Default: `False`*. <br />
        Whether to save the code to reproduce the plot.<br />
    - `save_data` *(`flag`)*: *Default: `False`*. <br />
        Whether to save the data used to generate the plot.<br />
    - `<more>`:
        Other arguments passed to `scplotter::FeatureStatPlot`.<br />
        See <https://user.github.io/scplotter/reference/FeatureStatPlot.html>
- `features` *(`type=json`)*: *Default: `{}`*. <br />
    The plots for features, include gene expressions, and columns from metadata.<br />
    Keys are the titles of the cases and values are the dicts inherited from `env.features_defaults`.<br />
- `dimplots_defaults` *(`ns`)*:
    The default parameters for `dimplots`.<br />
    - `group_by`: *Default: `seurat_clusters`*. <br />
        The identity to use.<br />
        If it is from subclustering (reduction `sub_umap_<ident>` exists), this reduction will be used if `reduction`
        is set to `dim` or `auto`.<br />
    - `split_by`:
        The column name in metadata to split the cells into different plots.<br />
    - `subset`:
        An expression to subset the cells, will be passed to `tidyrseurat::filter()`.<br />
    - `devpars` *(`ns`)*:
        The device parameters for the plots.<br />
        - `res` *(`type=int`)*: *Default: `100`*. <br />
            The resolution of the plots.<br />
        - `height` *(`type=int`)*:
            The height of the plots.<br />
        - `width` *(`type=int`)*:
            The width of the plots.<br />
    - `reduction` *(`choice`)*: *Default: `dim`*. <br />
        Which dimensionality reduction to use.<br />
        - `dim`:
            Use `Seurat::DimPlot`.<br />
            First searches for `umap`, then `tsne`, then `pca`.<br />
            If `ident` is from subclustering, `sub_umap_<ident>` will be used.<br />
        - `auto`:
            Same as `dim`
        - `umap`:
            Use `Seurat::UMAPPlot`.<br />
        - `tsne`:
            Use `Seurat::TSNEPlot`.<br />
        - `pca`:
            Use `Seurat::PCAPlot`.<br />
    - `<more>`:
        See <https://user.github.io/scplotter/reference/CellDimPlot.html>
- `dimplots` *(`type=json`)*: *Default: `{'Dimensional reduction plot': Diot({'label': True}), 'VDJ Presence': Diot({'group_by': 'VDJ_Presence'})}`*. <br />
    The dimensional reduction plots.<br />
    Keys are the titles of the plots and values are the dicts inherited from `env.dimplots_defaults`. It can also have other parameters from
    [`scplotter::CellDimPlot`](https://user.github.io/scplotter/reference/CellDimPlot.html).<br />

## Examples

### Number of cells in each cluster

```toml
[SeuratClusterStats.envs.stats]
# suppose you have nothing set in `envs.stats_defaults`
# otherwise, the settings will be inherited here
nCells_All = { }
```

![nCells_All](images/SeuratClusterStats_nCells_All.png){: width="80%" }

### Number of cells in each cluster by groups

```toml
[SeuratClusterStats.envs.stats]
nCells_Sample = { group_by = "Sample" }
```

![nCells_Sample](images/SeuratClusterStats_nCells_Sample.png){: width="80%" }

### Violin plots for the gene expressions

```toml
[SeuratClusterStats.envs.features]
features = "CD4,CD8A"
# Remove the dots in the violin plots
vlnplots = { pt-size = 0, kind = "vln" }
# Don't use the default genes
vlnplots_1 = { features = ["FOXP3", "IL2RA"], pt-size = 0, kind = "vln" }
```

![vlnplots](images/SeuratClusterStats_vlnplots.png){: width="80%" }
![vlnplots_1](images/SeuratClusterStats_vlnplots_1.png){: width="80%" }

### Dimension reduction plot with labels

```toml
[SeuratClusterStats.envs.dimplots.Idents]
label = true
```

![dimplots](images/SeuratClusterStats_dimplots.png){: width="80%" }

